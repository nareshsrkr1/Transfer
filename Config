import os
import shutil
import yaml
import concurrent.futures

def get_directory_size(dir_path):
    total_size = 0
    if os.path.exists(dir_path) and os.path.isdir(dir_path):
        for root, dirs, files in os.walk(dir_path):
            for file in files:
                file_path = os.path.join(root, file)
                if not os.path.islink(file_path):  # Skip symbolic links
                    total_size += os.path.getsize(file_path)
    return total_size

def scan_directory(args):
    dir_path, threshold_space_limit = args
    directories_with_space = []
    
    dir_size = get_directory_size(dir_path)
    if dir_size > threshold_space_limit:
        for root, dirs, _ in os.walk(dir_path):
            for dir_name in dirs:
                dir_path = os.path.join(root, dir_name)
                dir_size = get_directory_size(dir_path)
                dir_size_gb = round(dir_size / (1024 ** 3), 2)
                
                if dir_size > threshold_space_limit:
                    directories_with_space.append((dir_path, dir_size_gb))
    return directories_with_space

def get_directories_with_space(config_file):
    with open(config_file, 'r') as f:
        config = yaml.safe_load(f)['app_space_monitor']

    directories_with_space = []

    for app_config in config:
        app_name = app_config['name']
        threshold_space_limit = app_config['threshold'] * 1024 * 1024 * 1024  # Convert GB to bytes
        
        for path_entry in app_config.get('paths', []):
            app_path = path_entry['path']
            with concurrent.futures.ThreadPoolExecutor() as executor:
                results = executor.map(scan_directory, [(app_path, threshold_space_limit)])
                for result in results:
                    directories_with_space.extend(result)
    return directories_with_space

# Example usage
config_file = 'config.yml'
result = get_directories_with_space(config_file)

if result:
    print("Directories with space more than threshold limit:")
    for dir_path, space_used in result:
        print(f"Directory Path: {dir_path}, Space Used: {space_used} GB")
else:
    print("No directories found with space more than threshold limit.")
