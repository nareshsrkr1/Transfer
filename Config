import os
import yaml
import subprocess
import concurrent.futures
import pyodbc
import socket

def get_directory_size(dir_path):
    try:
        du_output = subprocess.check_output(['du', '-sb', dir_path])
        size_str, _ = du_output.split(maxsplit=1)
        size_str = size_str.decode('utf-8').strip()
        return int(size_str.split()[0])
    except subprocess.CalledProcessError:
        return -1

def save_to_db(results):
    conn = pyodbc.connect(Constants.Connection)
    cursor = conn.cursor()

    try:
        for result in results:
            app_name, sub_app_name, path, size, used_space = result
            cursor.execute('''INSERT INTO directory_sizes (hostname, app_name, sub_app_name, path, size, used_space)
                              VALUES (?, ?, ?, ?, ?, ?)''', (hostname, app_name, sub_app_name, path, size, used_space))
        conn.commit()
        print("Data inserted successfully.")
    except pyodbc.Error as e:
        print("Data insertion failed:", e)
    finally:
        conn.close()

def get_directories_with_size(config_file):
    with open(config_file, 'r') as f:
        config = yaml.safe_load(f)['apps_space_monitor']

    results = []

    for app_config in config:
        app_name = app_config['name']
        paths = app_config.get('paths', [])
        threshold = app_config.get('threshold', 0)

        with concurrent.futures.ThreadPoolExecutor() as executor:
            future_to_path = {executor.submit(get_directory_size, path_entry['path']): path_entry for path_entry in paths}
            for future in concurrent.futures.as_completed(future_to_path):
                path_entry = future_to_path[future]
                sub_app_name = path_entry['name']
                path = path_entry['path']
                size = future.result()
                if threshold == 0:
                    total, used, free = shutil.disk_usage(path)
                    used_space = round(used / (1024 ** 3), 2)
                    results.append((app_name, sub_app_name, path, size, used_space))
                else:
                    results.append((app_name, sub_app_name, path, size, None))

    return results

if __name__ == '__main__':
    Constants = Constants() # Assuming Constants is a class or module containing connection details
    hostname = socket.gethostname()
    config_file = 'config.yml'
    results = get_directories_with_size(config_file)

    if results:
        save_to_db(results)
    else:
        print("No directories found with space more than threshold limit.")
