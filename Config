#!/bin/bash

# Read configuration from config.ini
source_dir=$(awk -F '= ' '/\[input_files\]/{f=1; next} /\[.*\]/{f=0} f&&NF&&/source_dir/{print $NF}' config.ini)
destination_dir=$(awk -F '= ' '/\[input_files\]/{f=1; next} /\[.*\]/{f=0} f&&NF&&/destination_dir/{print $NF}' config.ini)
input_files=$(awk -F '= ' '/\[input_files\]/{f=1; next} /\[.*\]/{f=0} f&&NF&&/files/{print $NF}' config.ini)

# Ensure the destination directory exists
mkdir -p "$destination_dir"

# Iterate through the input files specified in the configuration
for input_file_pattern in $(echo "$input_files" | tr ',' '\n'); do
    # Find files matching the wildcard pattern
    matching_files=$(find "$source_dir" -maxdepth 1 -type f -name "$input_file_pattern")

    # Iterate through matching files
    for dat_file_path in $matching_files; do
        # Get the base filename without extension
        base_filename=$(basename "$dat_file_path" .dat)

        # Zip the file
        zip "$destination_dir/$base_filename.zip" "$dat_file_path"

        # Tar and gzip the file
        tar -czf "$destination_dir/$base_filename.tar.gz" -C "$source_dir" "$dat_file_path"

        # Optionally, remove the original .dat file
        # rm "$dat_file_path"
    done
done

echo "Processing complete."
